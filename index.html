<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Escala de Férias – Portaria 2026</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;600;700&display=swap" rel="stylesheet">
<style>
  :root{ --bg:#eef3f3; --card:#fff; --muted:#6b7280; --accent:#00b3a4; --err:#ef4444; font-family:Inter,Arial,sans-serif}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:#0b1720}
  header{background:linear-gradient(90deg,var(--accent),#16a085);color:#fff;padding:18px;text-align:center;font-weight:700}
  .wrap{max-width:1100px;margin:18px auto;padding:12px}
  .months{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  @media(max-width:900px){ .months{grid-template-columns:repeat(2,1fr)} }
  .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.06);border-left:6px solid var(--accent)}
  .card.full{border-left-color:var(--err);background:#fff5f5}
  .small{font-size:13px;color:var(--muted)}
  .form{margin-top:18px;background:var(--card);padding:16px;border-radius:10px}
  input,select,button{width:100%;padding:12px;margin-top:8px;border-radius:8px;border:1px solid #e6eef6;font-size:15px}
  button{background:var(--accent);color:#021224;border:0;font-weight:700;cursor:pointer}
  button.ghost{background:transparent;color:var(--muted);border:1px solid #eef2f2}
  .row{display:flex;gap:12px}
  .row > *{flex:1}
  .muted{color:var(--muted)}
  .admin-actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
</style>
</head>
<body>
  <header>Escala de Férias – Portaria 2026</header>
  <div class="wrap">

    <div id="monthsGrid" class="months"></div>

    <div class="form">
      <h3>Registrar Preferência</h3>
      <div class="small">Nome completo e CPF obrigatórios. Se já registrado, o envio atualiza suas preferências.</div>

      <input id="name" placeholder="Nome completo">
      <input id="cpf" placeholder="CPF (somente números)">

      <label class="small" style="margin-top:8px">1ª opção</label>
      <select id="m1"></select>

      <label class="small">2ª opção</label>
      <select id="m2"></select>

      <label class="small">3ª opção</label>
      <select id="m3"></select>

      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="btnSend">Enviar</button>
        <button id="btnMyStatus" class="ghost">Meu status</button>
      </div>

      <div id="statusMsg" class="small" style="margin-top:10px"></div>
      <div style="margin-top:12px" class="admin-actions">
        <button id="btnADM" class="ghost">Painel ADM</button>
      </div>
    </div>

    <div id="adminPanel" style="display:none;margin-top:14px" class="form">
      <h3>Painel ADM</h3>
      <input type="password" id="admPass" placeholder="Senha ADM">
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="btnAdmLogin">Entrar</button>
        <button id="btnAdmLogout" class="ghost" style="display:none">Sair</button>
        <button id="btnExport" class="ghost" style="display:none">Exportar CSV</button>
        <button id="btnReset" class="ghost" style="display:none">Resetar dados</button>
      </div>
      <div id="admList" style="margin-top:12px"></div>
    </div>
  </div>

<script>
/* === CONFIG === */
const API = "https://script.google.com/macros/s/AKfycbyF35LglhpnXZPAX-nssi5Hzz90_lsjv6fjFScHWdQgBP6mAK8vuBrgQ5kF8ChgMzzk/exec";
const MONTHS = ["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
const MONTH_LIMIT = 3;
const ADM_PASSWORD = "lig@457812#";

/* === UI references === */
const monthsGrid = document.getElementById('monthsGrid');
const m1 = document.getElementById('m1'), m2 = document.getElementById('m2'), m3 = document.getElementById('m3');
const btnSend = document.getElementById('btnSend'), statusMsg = document.getElementById('statusMsg');
const btnADM = document.getElementById('btnADM'), adminPanel = document.getElementById('adminPanel');
const btnAdmLogin = document.getElementById('btnAdmLogin'), btnAdmLogout = document.getElementById('btnAdmLogout');
const admPass = document.getElementById('admPass'), admList = document.getElementById('admList');
const btnExport = document.getElementById('btnExport'), btnReset = document.getElementById('btnReset');
const btnMyStatus = document.getElementById('btnMyStatus');

/* === Estado === */
let registrations = []; // rows from sheet (array of arrays)
let headers = [];

/* === Inicialização === */
function fillSelects(){
  [m1,m2,m3].forEach(s=>{
    s.innerHTML = '<option value="">Selecione</option>';
    MONTHS.forEach(m => {
      const op = document.createElement('option'); op.value = m; op.textContent = m;
      s.appendChild(op);
    });
  });
}
fillSelects();

/* Fetch data (read) */
async function fetchData(){
  try{
    const res = await fetch(`${API}?action=read`);
    const json = await res.json();
    headers = json.headers || [];
    registrations = json.data || [];
    // registrations are arrays matching sheet columns: nome, cpf, mes1, mes2, mes3, mesFinal?, timestamp?
    renderMonths();
    renderAdminListIfLogged();
  }catch(e){
    console.error(e);
    showStatus('Erro ao conectar ao servidor. Verifique o Web App.', true);
  }
}

/* Count assigned per month (using mesFinal column when present; else fallback to counting previous mesFinal-like column) */
function countAssigned(){
  const counts = {};
  MONTHS.forEach(m => counts[m]=0);
  registrations.forEach(row=>{
    // prefer column 5 (index 5) mesFinal if present
    const mesFinal = row[5] || ""; // if we deployed updated Apps Script, mesFinal is at index 5
    if(mesFinal && MONTHS.includes(mesFinal)) counts[mesFinal]++;
    // fallback: if mesFinal empty but there is preferences, do not count (we only count final assignments)
  });
  return counts;
}

/* Decide monthFinal for a new registration given prefs and the current counts */
function decideFinalMonth(pref1,pref2,pref3){
  const counts = countAssigned();
  const prefs = [pref1,pref2,pref3];
  for(const p of prefs){
    if(!p) continue;
    if((counts[p]||0) < MONTH_LIMIT) return p;
  }
  return null; // none available
}

/* Render months grid with counts */
function renderMonths(){
  const counts = countAssigned();
  monthsGrid.innerHTML = '';
  MONTHS.forEach(m=>{
    const c = counts[m] || 0;
    const div = document.createElement('div');
    div.className = 'card' + (c >= MONTH_LIMIT ? ' full' : '');
    div.innerHTML = `<div style="font-weight:700">${m}</div><div class="small">${c}/${MONTH_LIMIT} vagas</div>`;
    monthsGrid.appendChild(div);
  });
  // disable selects for months that are full
  [m1,m2,m3].forEach(s=>{
    [...s.options].forEach(opt=>{
      if(opt.value === "") return;
      opt.disabled = (counts[opt.value] >= MONTH_LIMIT);
    });
  });
}

/* Show status message */
function showStatus(text, isErr=false, timeout=4000){
  statusMsg.style.color = isErr ? 'var(--err)' : '';
  statusMsg.textContent = text;
  if(timeout) setTimeout(()=>{ if(statusMsg.textContent===text) statusMsg.textContent=''; }, timeout);
}

/* Send registration (calculate mesFinal first) */
async function sendRegistration(){
  const name = document.getElementById('name').value.trim();
  const cpf = document.getElementById('cpf').value.trim();
  const pref1 = m1.value, pref2 = m2.value, pref3 = m3.value;
  if(!name || !cpf){ showStatus('Nome e CPF são obrigatórios.', true); return; }
  if(!pref1){ showStatus('Escolha ao menos a 1ª opção.', true); return; }

  // decide mesFinal using current server data
  const mesFinal = decideFinalMonth(pref1,pref2,pref3);
  if(!mesFinal){ showStatus('Nenhum dos meses escolhidos possui vaga. Escolha outros meses.', true); return; }

  // send to server including mesFinal
  const url = `${API}?action=write&nome=${encodeURIComponent(name)}&cpf=${encodeURIComponent(cpf)}&mes1=${encodeURIComponent(pref1)}&mes2=${encodeURIComponent(pref2)}&mes3=${encodeURIComponent(pref3)}&mesFinal=${encodeURIComponent(mesFinal)}`;
  try{
    await fetch(url);
    showStatus(`Preferência registrada. Mês alocado: ${mesFinal}`, false);
    // clear form
    document.getElementById('name').value=''; document.getElementById('cpf').value=''; m1.selectedIndex=0; m2.selectedIndex=0; m3.selectedIndex=0;
    // refresh data from server
    await fetchData();
  }catch(e){
    console.error(e); showStatus('Erro ao enviar. Tente novamente.', true);
  }
}

/* Admin functions */
function openAdminPanel(){ adminPanel.style.display = 'block'; }
btnADM.addEventListener('click', openAdminPanel);

async function adminLogin(){
  const pass = admPass.value || prompt('Digite a senha ADM:');
  if(!pass) return;
  if(pass !== ADM_PASSWORD){ alert('Senha incorreta'); return; }
  btnAdmLogin.style.display = 'none';
  btnAdmLogout.style.display = 'inline-block';
  btnExport.style.display = 'inline-block';
  btnReset.style.display = 'inline-block';
  admPass.value = '';
  renderAdminListIfLogged();
}

function adminLogout(){
  btnAdmLogin.style.display = 'inline-block';
  btnAdmLogout.style.display = 'none';
  btnExport.style.display = 'none';
  btnReset.style.display = 'none';
  admList.innerHTML = '';
}

function renderAdminListIfLogged(){
  // show registrations with line numbers to allow delete
  if(btnAdmLogout.style.display === 'none') return; // not logged
  // registrations is array of arrays; the API returned data without headers; BUT when reading, the first row was headers and removed, so indexes correspond to sheet rows starting row2 -> line number = index+2
  let html = '';
  registrations.forEach((r, idx)=>{
    // r example: [nome, cpf, mes1, mes2, mes3, mesFinal, timestamp]
    const nome = r[0] || '';
    const cpf = r[1] || '';
    const mes1 = r[2] || '';
    const mes2 = r[3] || '';
    const mes3 = r[4] || '';
    const mesFinal = r[5] || '';
    const lineNumber = idx + 2;
    html += `<div style="padding:8px;border-bottom:1px solid #f0f3f3;display:flex;justify-content:space-between;align-items:center">
      <div><strong>${nome}</strong><div class="small">${cpf} • prefs: ${mes1} • ${mes2} • ${mes3} → <strong>${mesFinal||'(sem alocação)'}</strong></div></div>
      <div style="display:flex;gap:6px"><button class="ghost" onclick="deleteLine(${lineNumber})">Excluir</button></div>
    </div>`;
  });
  admList.innerHTML = html;
}

async function deleteLine(line){
  if(!confirm('Excluir linha ' + line + ' ?')) return;
  try{
    await fetch(`${API}?action=delete&linha=${line}`);
    showStatus('Registro removido.', false);
    await fetchData();
    renderAdminListIfLogged();
  }catch(e){ console.error(e); showStatus('Erro ao remover.', true); }
}

async function exportCSV(){
  // simple export from current registration snapshot
  const rows = [["Nome","CPF","Mes1","Mes2","Mes3","MesFinal"]];
  registrations.forEach(r => rows.push([r[0]||'', r[1]||'', r[2]||'', r[3]||'', r[4]||'', r[5]||'']));
  const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'escala_ferias.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* reset all (admin) - deletes all rows (keeps header) */
async function resetAll(){
  if(!confirm('Resetar todos os dados?')) return;
  // We'll delete rows one by one from bottom to top using delete action
  // But the Apps Script supports delete by row. Here we can compute how many rows and delete them.
  const total = registrations.length;
  try{
    for(let i=0;i<total;i++){
      // always delete row 2 (after header) repeatedly
      await fetch(`${API}?action=delete&linha=2`);
    }
    showStatus('Dados resetados.', false);
    await fetchData();
  }catch(e){ console.error(e); showStatus('Erro ao resetar.', true); }
}

/* Wire UI */
btnSend.addEventListener('click', sendRegistration);
btnAdmLogin.addEventListener('click', adminLogin);
btnAdmLogout.addEventListener('click', adminLogout);
btnExport.addEventListener('click', exportCSV);
btnReset.addEventListener('click', resetAll);
btnMyStatus.addEventListener('click', async ()=>{
  const cpf = document.getElementById('cpf').value.trim();
  if(!cpf){ showStatus('Digite seu CPF para ver status.', true); return; }
  // find in current registrations (cpf normalized)
  const found = registrations.find(r => (r[1]||'').toString() === cpf.toString());
  if(!found) { showStatus('Nenhum registro encontrado para esse CPF.', true); return; }
  showStatus(`Você foi alocado em: ${found[5] || 'Sem alocação'}`, false, 7000);
});

/* start */
fetchData();
setInterval(fetchData, 8000); // keep dashboard fresh every 8s

</script>
</body>
</html>
