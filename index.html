<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escala de FÃ©rias 2025</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        const VacationScheduler = () => {
          const [employees, setEmployees] = useState([]);
          const [currentEmployee, setCurrentEmployee] = useState('');
          const [currentCPF, setCurrentCPF] = useState('');
          const [choices, setChoices] = useState(['', '', '']);
          const [schedule, setSchedule] = useState({});
          const [showSuccess, setShowSuccess] = useState(false);
          const [error, setError] = useState('');

          const months = [
            'Janeiro', 'Fevereiro', 'MarÃ§o', 'Abril', 'Maio', 'Junho',
            'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
          ];

          useEffect(() => {
            loadData();
          }, []);

          const loadData = async () => {
            try {
              const [employeesData, scheduleData] = await Promise.all([
                window.storage.get('vacation-employees', true),
                window.storage.get('vacation-schedule', true)
              ]);
              
              if (employeesData?.value) {
                setEmployees(JSON.parse(employeesData.value));
              }
              if (scheduleData?.value) {
                setSchedule(JSON.parse(scheduleData.value));
              }
            } catch (err) {
              console.log('Iniciando dados vazios');
            }
          };

          const saveData = async (newEmployees, newSchedule) => {
            try {
              await Promise.all([
                window.storage.set('vacation-employees', JSON.stringify(newEmployees), true),
                window.storage.set('vacation-schedule', JSON.stringify(newSchedule), true)
              ]);
            } catch (err) {
              setError('Erro ao salvar dados. Tente novamente.');
            }
          };

          const formatCPF = (value) => {
            const numbers = value.replace(/\D/g, '');
            if (numbers.length <= 11) {
              return numbers
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            }
            return value;
          };

          const validateCPF = (cpf) => {
            const numbers = cpf.replace(/\D/g, '');
            return numbers.length === 11;
          };

          const getMonthCount = (month) => {
            return Object.values(schedule).filter(emp => emp.assignedMonth === month).length;
          };

          const canAssignMonth = (month) => {
            return getMonthCount(month) < 3;
          };

          const assignVacations = (employeeData) => {
            const newSchedule = { ...schedule };
            
            for (let choice of employeeData.choices) {
              if (choice && canAssignMonth(choice)) {
                newSchedule[employeeData.cpf] = {
                  ...employeeData,
                  assignedMonth: choice,
                  timestamp: Date.now()
                };
                return newSchedule;
              }
            }
            
            newSchedule[employeeData.cpf] = {
              ...employeeData,
              assignedMonth: null,
              timestamp: Date.now()
            };
            return newSchedule;
          };

          const handleSubmit = async () => {
            setError('');

            if (!currentEmployee.trim()) {
              setError('Por favor, digite seu nome');
              return;
            }

            if (!currentCPF.trim()) {
              setError('Por favor, digite seu CPF');
              return;
            }

            if (!validateCPF(currentCPF)) {
              setError('CPF invÃ¡lido! Digite os 11 dÃ­gitos do CPF.');
              return;
            }

            const cpfNumbers = currentCPF.replace(/\D/g, '');

            // Verifica se o CPF jÃ¡ foi usado
            const alreadyFilled = employees.some(e => 
              e.cpf.replace(/\D/g, '') === cpfNumbers
            );
            
            if (alreadyFilled) {
              setError('âŒ Este CPF jÃ¡ foi utilizado! Cada colaborador pode preencher apenas uma vez.');
              return;
            }

            const validChoices = choices.filter(c => c !== '');
            if (validChoices.length === 0) {
              setError('Selecione pelo menos uma opÃ§Ã£o de mÃªs');
              return;
            }

            const uniqueChoices = new Set(validChoices);
            if (uniqueChoices.size !== validChoices.length) {
              setError('VocÃª nÃ£o pode selecionar o mesmo mÃªs mais de uma vez');
              return;
            }

            const employeeData = {
              name: currentEmployee.trim(),
              cpf: currentCPF,
              choices: choices,
              timestamp: Date.now()
            };

            const newSchedule = assignVacations(employeeData);
            const newEmployees = [...employees, employeeData];

            await saveData(newEmployees, newSchedule);
            setEmployees(newEmployees);
            setSchedule(newSchedule);
            setShowSuccess(true);
            setCurrentEmployee('');
            setCurrentCPF('');
            setChoices(['', '', '']);
            
            setTimeout(() => setShowSuccess(false), 3000);
          };

          const exportToCSV = () => {
            const password = prompt('Digite a senha de administrador para exportar:');
            
            if (password !== 'lig@457812#') {
              alert('âŒ Senha incorreta! Apenas administradores podem exportar os dados.');
              return;
            }
            
            let csv = 'Nome,CPF,1Âª Escolha,2Âª Escolha,3Âª Escolha,MÃªs AtribuÃ­do,Status\n';
            
            employees.forEach(emp => {
              const assigned = schedule[emp.cpf];
              const status = assigned?.assignedMonth ? 'Confirmado' : 'Aguardando';
              csv += `${emp.name},${emp.cpf},${emp.choices[0] || '-'},${emp.choices[1] || '-'},${emp.choices[2] || '-'},${assigned?.assignedMonth || 'NÃ£o alocado'},${status}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `escala-ferias-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
          };

          const resetData = async () => {
            const password = prompt('Digite a senha de administrador para resetar os dados:');
            
            if (password !== 'lig@457812#') {
              alert('âŒ Senha incorreta! Apenas administradores podem resetar os dados.');
              return;
            }
            
            if (window.confirm('Tem certeza que deseja resetar todos os dados? Esta aÃ§Ã£o nÃ£o pode ser desfeita.')) {
              try {
                await Promise.all([
                  window.storage.delete('vacation-employees', true),
                  window.storage.delete('vacation-schedule', true)
                ]);
                setEmployees([]);
                setSchedule({});
                setError('');
                alert('âœ… Dados resetados com sucesso!');
              } catch (err) {
                setError('Erro ao resetar dados');
              }
            }
          };

          return React.createElement('div', { className: 'min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4' },
            React.createElement('div', { className: 'max-w-6xl mx-auto' },
              React.createElement('div', { className: 'bg-white rounded-lg shadow-xl p-6 mb-6' },
                React.createElement('div', { className: 'flex items-center justify-between mb-6' },
                  React.createElement('div', { className: 'flex items-center gap-3' },
                    React.createElement('svg', { className: 'w-8 h-8 text-indigo-600', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                      React.createElement('rect', { x: '3', y: '4', width: '18', height: '18', rx: '2', ry: '2' }),
                      React.createElement('line', { x1: '16', y1: '2', x2: '16', y2: '6' }),
                      React.createElement('line', { x1: '8', y1: '2', x2: '8', y2: '6' }),
                      React.createElement('line', { x1: '3', y1: '10', x2: '21', y2: '10' })
                    ),
                    React.createElement('h1', { className: 'text-3xl font-bold text-gray-800' }, 'Escala de FÃ©rias 2025')
                  ),
                  React.createElement('div', { className: 'flex gap-2' },
                    React.createElement('button', {
                      onClick: exportToCSV,
                      className: 'flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition'
                    }, 'ðŸ“¥ Exportar'),
                    React.createElement('button', {
                      onClick: resetData,
                      className: 'flex items-center gap-2 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition'
                    }, 'ðŸ—‘ï¸ Resetar')
                  )
                ),

                showSuccess && React.createElement('div', { className: 'mb-4 p-4 bg-green-100 border border-green-400 rounded-lg flex items-center gap-2' },
                  React.createElement('span', { className: 'text-green-800' }, 'âœ… FÃ©rias registradas com sucesso!')
                ),

                error && React.createElement('div', { className: 'mb-4 p-4 bg-red-100 border border-red-400 rounded-lg flex items-center gap-2' },
                  React.createElement('span', { className: 'text-red-800' }, error)
                ),

                React.createElement('div', { className: 'space-y-4' },
                  React.createElement('div', null,
                    React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Seu Nome Completo'),
                    React.createElement('input', {
                      type: 'text',
                      value: currentEmployee,
                      onChange: (e) => setCurrentEmployee(e.target.value),
                      className: 'w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent',
                      placeholder: 'Digite seu nome'
                    })
                  ),

                  React.createElement('div', null,
                    React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Seu CPF'),
                    React.createElement('input', {
                      type: 'text',
                      value: currentCPF,
                      onChange: (e) => setCurrentCPF(formatCPF(e.target.value)),
                      maxLength: 14,
                      className: 'w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent',
                      placeholder: '000.000.000-00'
                    })
                  ),

                  React.createElement('div', { className: 'grid md:grid-cols-3 gap-4' },
                    [0, 1, 2].map((index) =>
                      React.createElement('div', { key: index },
                        React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 
                          `${index + 1}Âª OpÃ§Ã£o de MÃªs`
                        ),
                        React.createElement('select', {
                          value: choices[index],
                          onChange: (e) => {
                            const newChoices = [...choices];
                            newChoices[index] = e.target.value;
                            setChoices(newChoices);
                          },
                          className: 'w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent'
                        },
                          React.createElement('option', { value: '' }, 'Selecione um mÃªs'),
                          months.map((month) =>
                            React.createElement('option', { key: month, value: month },
                              `${month} (${getMonthCount(month)}/3)`
                            )
                          )
                        )
                      )
                    )
                  ),

                  React.createElement('button', {
                    onClick: handleSubmit,
                    className: 'w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition font-medium'
                  }, 'Registrar Minhas FÃ©rias')
                )
              ),

              React.createElement('div', { className: 'grid md:grid-cols-2 gap-6' },
                React.createElement('div', { className: 'bg-white rounded-lg shadow-xl p-6' },
                  React.createElement('h2', { className: 'text-xl font-bold text-gray-800 mb-4' }, 'ðŸ“Š OcupaÃ§Ã£o dos Meses'),
                  React.createElement('div', { className: 'space-y-2' },
                    months.map((month) => {
                      const count = getMonthCount(month);
                      const percentage = (count / 3) * 100;
                      const isAvailable = count < 3;
                      
                      return React.createElement('div', { key: month, className: 'space-y-1' },
                        React.createElement('div', { className: 'flex justify-between text-sm' },
                          React.createElement('span', { className: 'font-medium' }, month),
                          React.createElement('span', { className: isAvailable ? 'text-green-600' : 'text-red-600' },
                            `${count}/3 ${isAvailable ? 'âœ“' : 'âœ—'}`
                          )
                        ),
                        React.createElement('div', { className: 'w-full bg-gray-200 rounded-full h-2' },
                          React.createElement('div', {
                            className: `h-2 rounded-full transition-all ${
                              percentage === 100 ? 'bg-red-500' :
                              percentage >= 66 ? 'bg-yellow-500' : 'bg-green-500'
                            }`,
                            style: { width: `${percentage}%` }
                          })
                        )
                      );
                    })
                  )
                ),

                React.createElement('div', { className: 'bg-white rounded-lg shadow-xl p-6' },
                  React.createElement('h2', { className: 'text-xl font-bold text-gray-800 mb-4' },
                    `ðŸ‘¥ Colaboradores Registrados (${employees.length}/31)`
                  ),
                  React.createElement('div', { className: 'max-h-96 overflow-y-auto space-y-2' },
                    employees.length === 0 ?
                      React.createElement('p', { className: 'text-gray-500 text-center py-8' },
                        'Nenhum colaborador registrado ainda'
                      ) :
                      employees.map((emp) => {
                        const assigned = schedule[emp.name];
                        return React.createElement('div', { key: emp.name, className: 'border border-gray-200 rounded-lg p-3' },
                          React.createElement('div', { className: 'flex justify-between items-start mb-2' },
                            React.createElement('span', { className: 'font-medium text-gray-800' }, emp.name),
                            assigned?.assignedMonth ?
                              React.createElement('span', { className: 'px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full' },
                                assigned.assignedMonth
                              ) :
                              React.createElement('span', { className: 'px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full' },
                                'Aguardando'
                              )
                          ),
                          React.createElement('div', { className: 'text-xs text-gray-600' },
                            `Escolhas: ${emp.choices.filter(c => c).join(', ') || 'Nenhuma'}`
                          )
                        );
                      })
                  )
                )
              )
            )
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(VacationScheduler));
    </script>
</body>
</html>
